name: Claude Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Triage issue with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You triage newly opened GitHub issues for this repository. Your only action is to APPLY LABELS.

            ## Hard Rules
            - Do not post comments.
            - Do not remove labels; only add.
            - Use ONLY labels that already exist in this repo (see step 1).
            - Cap at 4 labels total: one type + optional area + optional source + optional meta (needs-* or duplicate).
            - If unsure, add nothing.

            ## Context
            - repo: ${{ github.repository }}
            - issue_number: ${{ github.event.issue.number }}
            - You may read repository files to infer areas.

            ## Tools
            - Shell: run exactly `gh label list` to fetch available labels.
            - MCP GitHub:
              - mcp__github__get_issue → title, body, existing labels
              - mcp__github__get_issue_comments → extra context
              - mcp__github__search_issues → find similar open issues
              - mcp__github__list_issues → see labeling patterns
              - mcp__github__update_issue → apply labels (no comments)

            ## Block List (never auto-apply)
            - meta:good-first-issue, meta:help-wanted, meta:wontfix, meta:invalid, any that mention PRs

            PROCEDURE
            1) Build L = set of existing label names from `gh label list` (case-insensitive match; use exact spelling from L when applying).
            2) Fetch the issue via mcp__github__get_issue. Note title, body, and current labels.
            3) TYPE (pick at most one, first match that exists in L):
              - If title starts with “[bug]”, body says “ISSUE_TYPE: bug”, or clear defect language → add `type:bug`.
              - If “[feature]” or “ISSUE_TYPE: feature” or request for new capability → add `type:enhancement`.
              - If docs wording, README, examples, typos in docs → add `type:documentation`.
              - If this is a support-style question → `type:question`.
            4) SOURCE (optional, at most one, only if obvious in body):
              - youtube.com | youtu.be → `source:youtube`.
              - patreon.com → `source:patreon`.
              - x.com | twitter.com | tweet → `source:xitter`.
            5) AREA (optional, at most one; pick strongest cue; prefer more specific):
              - Mentions `yt-dlp`, download flags, ffmpeg → `area:yt-dlp`.
              - Otherwise involves downloading//managing/cleaning up files, data pipeline/coordinator → `area:downloader`.
              - RSS/feed terms (`rss`, `feed`, `/feeds`) → `area:rss`.
              - Config terms (`feeds.yaml`, `config`, `schema`) → `area:config`.
              - API terms (`endpoint`, `/admin`, FastAPI, routers) → `area:api`.
              - Docker terms (`docker`, compose, image tag, ghcr) → `area:docker`.
            6) META (optional):
              - If the bug lacks steps OR minimal config OR logs → add `meta:needs-repro`.
              - If the issue is ambiguous and more detail is needed → `meta:needs-info`.
              - If a clearly matching OPEN issue exists via mcp__github__search_issues → add `meta:duplicate`. Do not close or comment.
            7) Build the final label set:
              - Start with existing labels. Add at most one from TYPE, AREA, SOURCE, META.
              - If nothing new to add, stop.
            8) Apply:
              - Call mcp__github__update_issue with the full label list.
              - Do not output any comment.
              - It's okay to not add any labels if none are clearly applicable

          claude_args: |
            --allowedTools "Bash(gh label list),mcp__github__get_issue,mcp__github__get_issue_comments,mcp__github__update_issue,mcp__github__search_issues,mcp__github__list_issues"
