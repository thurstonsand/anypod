name: "Update Dockerfile Dependencies"

permissions:
  contents: write

on:
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: "0 1 * * *" # Runs daily at 01:00 UTC

jobs:
  update-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.ANYPOD_DEPLOY_KEY }}

      - name: Update Dockerfile if needed
        id: update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "ERROR: GITHUB_TOKEN is required to query the GitHub API"
            exit 1
          fi

          # Update bgutil provider to latest version using authenticated API request to avoid rate limits
          RESP=$(curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/brainicism/bgutil-ytdlp-pot-provider/releases/latest")

          if ! LATEST=$(echo "$RESP" | jq -er '.tag_name'); then
            echo "ERROR: Failed to parse latest bgutil version from GitHub API"
            echo "Full API response:"
            echo "$RESP"
            exit 1
          fi

          sed -i "s/^ARG BGUTIL_POT_PROVIDER_VERSION=.*/ARG BGUTIL_POT_PROVIDER_VERSION=${LATEST}/" Dockerfile

          # Update cache bust key to current week (forces package refresh)
          CURRENT_WEEK=$(date +%Y-W%V)
          sed -i "s/^ARG CACHE_BUST_WEEK=.*/ARG CACHE_BUST_WEEK=${CURRENT_WEEK}/" Dockerfile

          # Check if anything actually changed
          if git diff --quiet Dockerfile; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes needed"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Dockerfile updated"
          fi

      - name: Install uv
        if: steps.update.outputs.has_changes == 'true'
        uses: astral-sh/setup-uv@v7
        with:
          version: latest
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install project dependencies
        if: steps.update.outputs.has_changes == 'true'
        run: uv sync --locked --all-extras --dev

      - name: Run pre-commit checks
        if: steps.update.outputs.has_changes == 'true'
        uses: pre-commit/action@v3.0.1

      - name: Run tests
        if: steps.update.outputs.has_changes == 'true'
        run: |
          uv run pytest --cov-report xml

      - name: Commit and push
        if: steps.update.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add Dockerfile
          git commit -m "chore(deps): update dependencies and refresh package cache

          Auto-update performed by GitHub Actions after validating:
            - Dockerfile updated successfully
            - Pre-commit checks passed
            - All tests passed"
          git push origin main
